# Site Blocker Chrome拡張機能 仕様書

## 1. 概要

### 1.1 目的
指定した時間帯に特定のWebサイトへのアクセスをブロックするChrome拡張機能を開発する。主にSlackなどのSPAアプリケーションでの作業集中時間の確保を目的とするが、汎用的なサイトブロック機能として設計する。

### 1.2 主要機能
- Section Group単位でのURL管理
- 時間指定によるブロック制御
- ブロック時の専用ページ表示
- 直感的なポップアップUI

## 2. 機能要件

### 2.1 Section Group機能

#### 2.1.1 Section Groupの概念
- **定義**: 複数のURLとブロック時間をセットで管理する単位
- **目的**: 異なるサイトグループに対して個別のブロック時間を設定可能にする
- **例**: 
  - "SNS" グループ: Twitter、Facebook、Instagram
  - "仕事用Slack" グループ: 特定のSlackワークスペース
  - "動画サイト" グループ: YouTube、Netflix

#### 2.1.2 Section Groupの属性
- **グループ名**: ユーザーが設定する識別名（必須）
- **URL リスト**: ブロック対象のURL一覧
- **時間ブロック**: ブロックする時間帯の配列
- **有効/無効フラグ**: グループ全体のON/OFF制御

### 2.2 URL管理機能

#### 2.2.1 URL登録方法
- **手動登録**: ポップアップから現在のURLを指定グループに追加
- **登録条件**: 
  - 現在アクティブなタブのURLを取得
  - 重複チェック（同じURLの重複登録を防ぐ）
- **対象URL**: すべてのHTTP/HTTPSサイト

#### 2.2.2 URL削除機能
- グループ内の個別URL削除
- 削除前の確認は不要（操作の簡素化）

#### 2.2.3 URLマッチング仕様
- **部分一致**: 登録URLが現在のURLに含まれる場合にマッチ
- **例**: 
  - 登録URL: `https://app.slack.com/client/T123/C456`
  - マッチ対象: `https://app.slack.com/client/T123/C456/p789` ✓
  - 非マッチ: `https://app.slack.com/client/T123/C999` ✗

### 2.3 時間制御機能

#### 2.3.1 時間ブロック仕様
- **形式**: HH:MM - HH:MM（24時間表記）
- **複数設定**: 1つのグループに複数の時間ブロックを設定可能
- **例**: 
  - 10:00-12:00（午前の集中時間）
  - 14:00-16:00（午後の集中時間）

#### 2.3.2 時間判定ロジック
- **判定タイミング**: 
  - 初回ページ読み込み時
  - SPA内のページ遷移時（URLハッシュ変更、History API使用時）
  - 定期的な監視（URL変更の検知）
- **判定方式**: 現在時刻が設定された時間ブロック内にあるかチェック
- **日付跨ぎ**: 未対応（同日内の時間のみ）

### 2.4 ブロック機能

#### 2.4.1 ブロック動作
- **条件**: 以下すべてを満たす場合
  1. グループが有効状態
  2. 現在のURLがグループ内のいずれかのURLにマッチ
  3. 現在時刻がブロック時間内
- **動作**: 専用のブロックページにリダイレクト

#### 2.4.2 ブロックページ
- **表示内容**: 
  - "今は開けません！" メッセージ
  - ブロック理由（グループ名、時間帯）
  - 設定変更へのリンク
- **デザイン**: シンプルで分かりやすい表示

## 3. ユーザーインターフェース要件

### 3.1 ポップアップUI

#### 3.1.1 レイアウト構成
```
┌─────────────────────────────┐
│ Site Blocker               │
├─────────────────────────────┤
│ 現在のURL: [現在のURL表示]    │
├─────────────────────────────┤
│ [Section Group 1]          │
│   状態: ブロック中/非ブロック  │
│   □ 有効                   │
│   時間: 09:00-12:00 [削除]   │
│        14:00-17:00 [削除]   │
│   [時間追加]                │
│   URL: (3個) [詳細表示]      │
│   [現在のURLを追加] [削除]    │
├─────────────────────────────┤
│ [Section Group 2]          │
│   ...                      │
├─────────────────────────────┤
│ 新しいSection Group        │
│ [グループ名入力] [作成]      │
└─────────────────────────────┘
```

#### 3.1.2 UI要素仕様
- **幅**: 350px固定
- **高さ**: 内容に応じて可変
- **フォント**: システムフォント使用
- **色調**: 落ち着いたグレーベース

### 3.2 Section Group表示

#### 3.2.1 状態表示
- **ブロック中**: 緑色背景「ブロック中」
- **非ブロック**: 赤色背景「非ブロック」
- **無効**: グレー背景「無効」

#### 3.2.2 時間設定UI
- **入力形式**: HTML5 time input
- **追加ボタン**: 新しい時間ブロックを追加
- **削除ボタン**: 個別の時間ブロックを削除
- **制限**: 最低1つの時間ブロックは必須

#### 3.2.3 URL表示
- **表示形式**: 
  - URL数のカウント表示
  - 長いURLは省略表示（40文字制限）
  - ホバーで完全URL表示
- **削除**: 個別削除ボタン

## 4. 技術仕様

### 4.1 開発フレームワーク
- **フレームワーク**: WXT（Web Extension Tool）
- **言語**: TypeScript
- **ビルドツール**: Vite（WXTに内蔵）

### 4.2 Chrome Extension API

#### 4.2.1 必要な権限
- `storage`: 設定データの保存
- `activeTab`: 現在のタブURL取得
- `tabs`: タブ情報の取得
- `declarativeNetRequest`: URL制御（オプション）
- `<all_urls>`: 全サイトでの動作

#### 4.2.2 マニフェスト構成
- **バージョン**: Manifest V3
- **バックグラウンドスクリプト**: Service Worker
- **コンテンツスクリプト**: ブロック判定用
- **ポップアップ**: 設定UI

### 4.3 データ保存仕様

#### 4.3.1 ストレージ形式
```javascript
{
  "sectionGroups": {
    "グループ名1": {
      "name": "グループ名1",
      "urls": ["https://example.com", "https://test.com"],
      "timeBlocks": [
        {"start": "09:00", "end": "12:00"},
        {"start": "14:00", "end": "17:00"}
      ],
      "enabled": true
    },
    "グループ名2": {
      // 同様の構造
    }
  }
}
```

#### 4.3.2 データ同期
- **保存先**: chrome.storage.local
- **同期**: 設定変更時に即座に保存
- **バックアップ**: なし（ローカル保存のみ）

### 4.4 ブロック実装方式

#### 4.4.1 Content Script方式
- **動作**: 各ページでJavaScriptを実行してブロック判定
- **メリット**: 確実なブロック、SPA対応
- **実装**: document_start で実行
- **SPA対応**: 
  - MutationObserver による DOM 監視
  - popstate イベントの監視（History API）
  - hashchange イベントの監視（ハッシュルーティング）
  - 定期的なURL変更チェック（setInterval）

#### 4.4.2 判定フロー
```
1. ページ読み込み開始
2. Content Scriptが実行
3. 初回URL判定
4. SPA監視機能の設定
   - popstate イベントリスナー
   - hashchange イベントリスナー  
   - MutationObserver の設定
   - 定期監視タイマーの開始
5. URL変更検知時
   - 新しいURLを取得
   - Background Scriptにブロック判定を問い合わせ
   - ブロック対象の場合、専用ページに遷移
```

#### 4.4.3 SPA URL変更検知の詳細
- **History API監視**: `window.addEventListener('popstate', checkUrl)`
- **ハッシュ変更監視**: `window.addEventListener('hashchange', checkUrl)`
- **DOM変更監視**: `MutationObserver` でナビゲーション要素の変更を検知
- **定期チェック**: 1秒間隔で `location.href` の変更を監視
- **重複防止**: 前回チェック時のURLと比較して変更時のみ判定実行